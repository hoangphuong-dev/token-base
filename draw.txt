+----------------------------------------------------------------------------------------------------------------+
|                                          HỆ THỐNG TOKEN-BASED QUEUE                                             |
+----------------------------------------------------------------------------------------------------------------+
                                                        |
                          +------------------------------|-------------------------------+
                          |                              |                               |
                          v                              v                               v
+--------------------------+   +------------------------+   +---------------------------+
| QUẢN LÝ BỆNH NHÂN        |   | HỆ THỐNG PHÂN PHỐI    |   | HỆ THỐNG THEO DÕI         |
| VÀ TOKEN                 |   | VÀ CÂN BẰNG TẢI       |   | VÀ THÔNG BÁO              |
+--------------------------+   +------------------------+   +---------------------------+
            |                              |                               |
            v                              v                               v
+-----------------------------------------------------------------------------------------+
|                                                                                         |
|                                   QUY TRÌNH CHÍNH                                       |
|                                                                                         |
| +---------------------+     +----------------------+    +--------------------+          |
| |                     |     |                      |    |                    |          |
| | 1. BỆNH NHÂN ĐẾN    |---->| 2. ĐĂNG KÝ & PHÂN   |--->| 3. THỰC HIỆN       |          |
| |    CHECK-IN         |     |    LOẠI ƯU TIÊN     |    |    DỊCH VỤ          |          |
| |                     |     |                      |    |                    |          |
| +---------------------+     +----------------------+    +--------------------+          |
|          ^                            |                           |                     |
|          |                            v                           v                     |
| +---------------------+     +----------------------+    +--------------------+          |
| |                     |     |                      |    |                    |          |
| | 6. TIẾP TỤC HOẶC    |<----| 5. ĐỊNH TUYẾN DỊCH  |<---| 4. HOÀN THÀNH      |          |
| |    KẾT THÚC         |     |    VỤ TIẾP THEO     |    |    DỊCH VỤ          |          |
| |                     |     |                      |    |                    |          |
| +---------------------+     +----------------------+    +--------------------+          |
|                                                                                         |
+-----------------------------------------------------------------------------------------+
            |                              |                               |
            v                              v                               v
+-------------------------+   +-------------------------+   +---------------------------+
|                         |   |                         |   |                           |
| QUY TRÌNH PHÁT TOKEN    |   | QUY TRÌNH PHÂN PHÒNG    |   | QUY TRÌNH SẮP XẾP        |
| VÀ XỬ LÝ ƯU TIÊN        |   | (HASH RULE)             |   | HÀNG ĐỢI (SORT RULE)     |
|                         |   |                         |   |                           |
| +-----------+           |   | +-----------+           |   | +-----------+             |
| | Tạo Token |           |   | | Lấy danh  |           |   | | Sắp xếp   |             |
| +-----------+           |   | | sách phòng|           |   | | theo ưu   |             |
|       |                 |   | +-----------+           |   | | tiên &    |             |
|       v                 |   |       |                 |   | | thời gian |             |
| +-----------+           |   |       v                 |   | +-----------+             |
| | Xác định  |           |   | +-----------+           |   |       |                   |
| | mức ưu    |           |   | | Kiểm tra  |           |   |       v                   |
| | tiên      |           |   | | mức ưu    |           |   | +-----------+             |
| +-----------+           |   | | tiên      |           |   | | Cập nhật  |             |
|       |                 |   | +-----------+           |   | | vị trí &  |             |
|       v                 |   |       |                 |   | | thời gian |             |
| +-----------+           |   |       v                 |   | | chờ       |             |
| | Lưu token |           |   | +-----------+  Có       |   | +-----------+             |
| | vào DB    |-----------|-->| | Ưu tiên?  |--------+  |   |       |                   |
| +-----------+           |   | +-----------+        |  |   |       v                   |
|       |                 |   |       | Không        |  |   | +-----------+             |
|       |                 |   |       v              |  |   | | Thông báo |             |
|       |                 |   | +-----------+        |  |   | | bệnh nhân |             |
|       |                 |   | | Tính hash |        |  |   | +-----------+             |
|       |                 |   | | value     |        |  |   |                           |
|       |                 |   | +-----------+        |  |   | +-----------+             |
|       |                 |   |       |              |  |   | | Trạng thái|             |
|       |                 |   |       v              |  |   | | khẩn cấp  |<----+       |
| +-----------+           |   | +-----------+        |  |   | +-----------+     |       |
| | Trường hợp|           |   | | Phòng quá |  Có    |  |   |                   |       |
| | khẩn cấp  |-----------|---|->| tải?     |--------|--|-----------------------+       |
| +-----------+           |   | +-----------+        |  |   |                           |
|       |                 |   |       | Không        |  |   |                           |
|       v                 |   |       v              v  |   |                           |
| +-----------+           |   | +-----------+  +-----------+                           |
| | Lập ưu    |           |   | | Trả về    |  | Chọn phòng|                           |
| | tiên cao  |-----------|---|->| phòng    |<-| ít tải   |                           |
| | nhất      |           |   | +-----------+  +-----------+                           |
| +-----------+           |   |                                                         |
+-------------------------+   +---------------------------------------------------------+

+-----------------------------------------------------------------------------------------+
|                                                                                         |
|                           HỆ THỐNG CÂN BẰNG TẢI TỰ ĐỘNG                                 |
|                                                                                         |
| +-----------+     +-----------+     +-----------+     +-----------+     +-----------+   |
| | Kiểm tra  |---->| Xác định  |---->| Tìm phòng |---->| Chuyển    |---->| Thông báo |   |
| | tải phòng |     | phòng quá |     | tương     |     | bệnh nhân |     | bệnh nhân |   |
| |           |     | tải/nhàn  |     | thích     |     | sang phòng|     |           |   |
| +-----------+     +-----------+     +-----------+     +-----------+     +-----------+   |
|                          |                                                              |
|                          | Kích hoạt mỗi 10 phút                                        |
|                          v                                                              |
| +-----------+     +-----------+     +-----------+                                       |
| | Thu thập  |---->| Phân tích |---->| Báo cáo   |                                       |
| | thống kê  |     | hiệu suất |     | cho quản  |                                       |
| |           |     |           |     | trị       |                                       |
| +-----------+     +-----------+     +-----------+                                       |
+-----------------------------------------------------------------------------------------+

+-----------------------------------------------------------------------------------------+
|                                                                                         |
|                             QUY TRÌNH ĐỊNH TUYẾN DỊCH VỤ                                |
|                                                                                         |
| +-----------+     +-----------+                                                         |
| | Xác định  |---->| Lấy gói   |                                                         |
| | dịch vụ   |     | khám      |                                                         |
| | tiếp theo |     |           |                                                         |
| +-----------+     +-----------+                                                         |
|                          |                                                              |
|                          v                                                              |
|                   +-----------+                                                         |
|                   | Kiểm tra  |                                                         |
|                   | loại gói  |                                                         |
|                   +-----------+                                                         |
|                          |                                                              |
|         +----------------+----------------+                                             |
|         |                |                |                                             |
|         v                v                v                                             |
| +-----------+    +-----------+    +-----------+                                         |
| | Basic     |    | Standard  |    | Premium   |                                         |
| | (không    |    | (quy trình|    | (thêm dịch|                                         |
| | siêu âm)  |    | chuẩn)    |    | vụ)       |                                         |
| +-----------+    +-----------+    +-----------+                                         |
|         |                |                |                                             |
|         +----------------+----------------+                                             |
|                          |                                                              |
|                          v                                                              |
|                   +-----------+      +-----------+                                      |
|                   | Còn dịch  | Có   | Quay lại  |                                      |
|                   | vụ tiếp?  |----->| cấp token |                                      |
|                   +-----------+      +-----------+                                      |
|                          |                                                              |
|                         Không                                                           |
|                          |                                                              |
|                          v                                                              |
|                   +-----------+                                                         |
|                   | Hoàn thành|                                                         |
|                   | quá trình |                                                         |
|                   +-----------+                                                         |
+-----------------------------------------------------------------------------------------+

+-----------------------------------------------------------------------------------------+
|                                                                                         |
|                             CHÚ THÍCH QUY TRÌNH                                         |
|                                                                                         |
| 1. ĐĂNG KÝ & PHÂN LOẠI ƯU TIÊN:                                                        |
|    - Phân loại theo: tuổi, bệnh lý, mang thai, khuyết tật                              |
|    - Mức ưu tiên 0-5, khẩn cấp là 10                                                   |
|                                                                                         |
| 2. HASH RULE:                                                                           |
|    - Sử dụng hash từ ID bệnh nhân để phân bổ phòng                                     |
|    - Nếu phòng quá tải >150% → chuyển sang phòng ít tải                                |
|    - Bệnh nhân ưu tiên luôn vào phòng ít tải nhất                                      |
|                                                                                         |
| 3. SORT RULE:                                                                           |
|    - Sắp xếp theo ưu tiên (cao → thấp)                                                 |
|    - Cùng ưu tiên → sắp xếp theo thời gian (sớm → muộn)                               |
|    - Trường hợp khẩn cấp luôn ở đầu hàng đợi                                           |
|                                                                                         |
| 4. CÂN BẰNG TẢI:                                                                        |
|    - Kiểm tra tự động mỗi 10 phút                                                       |
|    - Phòng quá tải: thời gian chờ >30 phút                                             |
|    - Phòng nhàn rỗi: thời gian chờ <10 phút                                            |
|    - Chỉ chuyển tối đa 3 bệnh nhân mỗi lần                                             |
|                                                                                         |
| 5. QUY TRÌNH KHÁM:                                                                      |
|    - Basic: đăng ký → dấu hiệu sinh tồn → XN máu → X-quang → khám chuyên khoa → kết thúc|
|    - Standard: thêm siêu âm sau X-quang                                                |
|    - Premium: thêm các dịch vụ chuyên sâu                                              |
+-----------------------------------------------------------------------------------------+